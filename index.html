<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solo Leveling Grind</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/en/2/23/Solo_Leveling_logo.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: url('https://wallpapercave.com/wp/wp9420280.jpg') no-repeat center center fixed;
      background-size: cover;
      position: relative;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: -1;
    }
    .flash { animation: flashEffect 1s ease-in-out; }
    @keyframes flashEffect {
      0% { background-color: rgba(255,255,255,0.4); }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body class="text-white">
<div class="overlay"></div>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// === CONSTANTS ===
const normalPunishments = [
  "Do 20 push-ups", "Solve 50 GK questions", "Revise 2 topics",
  "No social media 6 hrs", "Read 30 pages"
];
const deathModePunishments = [
  "Study 6 hrs straight + summary", "200 questions + 50 push-ups",
  "Write all formulas twice", "Full mock test now + No phone 8 hrs", "Revise 5 topics + Cold shower"
];
const rewards = [
  "Watch 1 anime episode", "Eat favorite snack", "Listen to music", "Take a relaxing bath", "Play a game for 20 mins"
];
const rankTitles = ['E-Rank Hunter','D-Rank','C-Rank','B-Rank','A-Rank','S-Rank'];
const characterImages = [
  'https://cdn.jsdelivr.net/gh/Ashwinvalento/cartoon-avatar@master/lib/images/male/45.png',
  'https://cdn.jsdelivr.net/gh/Ashwinvalento/cartoon-avatar@master/lib/images/male/20.png',
  'https://cdn.jsdelivr.net/gh/Ashwinvalento/cartoon-avatar@master/lib/images/female/68.png',
  'https://cdn.jsdelivr.net/gh/Ashwinvalento/cartoon-avatar@master/lib/images/female/21.png'
];

function getXPForLevel(level){ return level*level*100; }
function getRank(level){
  if(level<5)return rankTitles[0];
  if(level<10)return rankTitles[1];
  if(level<15)return rankTitles[2];
  if(level<20)return rankTitles[3];
  if(level<25)return rankTitles[4];
  return rankTitles[5];
}

function App(){
  const [xp,setXP]=useState(parseInt(localStorage.getItem('xp'))||0);
  const [level,setLevel]=useState(parseInt(localStorage.getItem('level'))||1);
  const [tasks,setTasks]=useState(JSON.parse(localStorage.getItem('tasks'))||[]);
  const [habits,setHabits]=useState(JSON.parse(localStorage.getItem('habits'))||[]);
  const [punishments,setPunishments]=useState(JSON.parse(localStorage.getItem('punishments'))||[]);
  const [showAddModal,setShowAddModal]=useState(false);
  const [newTask,setNewTask]=useState({type:'daily',title:'',start:'',end:'',days:''});
  const [bossCountdown,setBossCountdown]=useState(parseInt(localStorage.getItem('bossCountdown'))||0);
  const [rivalXP,setRivalXP]=useState(parseInt(localStorage.getItem('rivalXP'))||0);
  const [rivalLevel,setRivalLevel]=useState(parseInt(localStorage.getItem('rivalLevel'))||1);
  const [behindDays,setBehindDays]=useState(parseInt(localStorage.getItem('behindDays'))||0);
  const [showLevelUp,setShowLevelUp]=useState(false);
  const [lockdown,setLockdown]=useState(false);
  const [timer, setTimer] = useState(getRemainingBossTime());

  // ✅ NEW STATES FOR DAILY QUEST & RELAPSE
  const [dailyQuest,setDailyQuest]=useState(JSON.parse(localStorage.getItem('dailyQuest'))||generateDailyQuest());
  const [relapseCount,setRelapseCount]=useState(parseInt(localStorage.getItem('relapseCount'))||0);

  // === Timer Functions ===
  function startBossTimer(hours) {
    const endTime = Date.now() + hours * 60 * 60 * 1000;
    localStorage.setItem('bossEndTime', endTime);
  }
  function getRemainingBossTime() {
    const endTime = parseInt(localStorage.getItem('bossEndTime')) || 0;
    const now = Date.now();
    return Math.max(0, endTime - now);
  }
  function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    return `${hrs}h ${mins}m ${secs}s`;
  }

  // === Save State ===
  useEffect(()=>{
    localStorage.setItem('xp',xp);
    localStorage.setItem('level',level);
    localStorage.setItem('tasks',JSON.stringify(tasks));
    localStorage.setItem('habits',JSON.stringify(habits));
    localStorage.setItem('punishments',JSON.stringify(punishments));
    localStorage.setItem('bossCountdown',bossCountdown);
    localStorage.setItem('rivalXP',rivalXP);
    localStorage.setItem('rivalLevel',rivalLevel);
    localStorage.setItem('behindDays',behindDays);
    localStorage.setItem('dailyQuest',JSON.stringify(dailyQuest));
    localStorage.setItem('relapseCount',relapseCount);
  },[xp,level,tasks,habits,punishments,bossCountdown,rivalXP,rivalLevel,behindDays,dailyQuest,relapseCount]);

  // === LEVEL UP ===
  useEffect(()=>{
    if(xp>=getXPForLevel(level)){
      setXP(xp-getXPForLevel(level));
      setLevel(level+1);
      setShowLevelUp(true);
      setTimeout(()=>setShowLevelUp(false),2000);
    }
  },[xp]);

  // ✅ DAILY QUEST RESET
  useEffect(()=>{
    const today=new Date().toDateString();
    const lastReset=localStorage.getItem('lastReset');
    if(lastReset!==today){
      const resetHabits=habits.map(h=>({...h,done:false}));
      setHabits(resetHabits);
      localStorage.setItem('lastReset',today);
      setDailyQuest(generateDailyQuest()); // NEW QUEST DAILY
    }
  },[]);
  // === RIVAL PROGRESSION ===
  useEffect(()=>{
    const interval=setInterval(()=>{
      const gain=Math.floor(Math.random()*2);
      setRivalXP(prev=>{
        let newXP=prev+gain;
        if(newXP>=getXPForLevel(rivalLevel)){
          newXP=newXP-getXPForLevel(rivalLevel);
          setRivalLevel(rivalLevel+1);
        }
        return newXP;
      });
    },3600000);
    return()=>clearInterval(interval);
  },[rivalLevel]);

  // ✅ RELAPSE SYSTEM FUNCTION
  function triggerRelapse(){
    alert("Relapse Detected! Heavy Penalty Applied!");
    setXP(Math.max(0,xp-50)); // XP loss
    setRelapseCount(relapseCount+1);
    addPunishment({type:'relapse',text:`Relapse Penalty! Do 100 push-ups + No phone for 4 hrs!`,deathMode:true});
  }

  // ✅ DAILY QUEST GENERATOR
  function generateDailyQuest(){
    const questList=[
      "Complete 5 study tasks",
      "Read 20 pages",
      "Do 30 push-ups",
      "Practice 20 math problems",
      "Write 2 pages summary"
    ];
    const randomQuest=questList[Math.floor(Math.random()*questList.length)];
    return {text:randomQuest,done:false,reward:10}; // reward XP
  }
  function completeDailyQuest(){
    setDailyQuest({...dailyQuest,done:true});
    setXP(xp+dailyQuest.reward);
    alert(`Daily Quest Complete! +${dailyQuest.reward} XP`);
  }

  // === Punishment, Boss & Dungeon Logic ===
  function addPunishment(p) {
    if (p.type === 'boss') { startBossTimer(3); }
    else if (p.type === 'weeklyBoss') { startBossTimer(10); }
    else if (p.type === 'dungeon') { startBossTimer(24); }
    setPunishments([...punishments, p]);
    setLockdown(true);
  }
  function completePunishment() {
    const [first, ...rest] = punishments;
    let userGain = 0; let rivalGain = 0;
    if (first.type === 'boss') { userGain = 4; rivalGain = 2; alert(`Boss Defeated! +${userGain} XP`); }
    else if (first.type === 'weeklyBoss') { userGain = 10; rivalGain = 5; alert(`Weekly Boss Defeated! +${userGain} XP`); }
    else if (first.type === 'dungeon') { userGain = 20; rivalGain = 10; alert(`Dungeon Cleared! +${userGain} XP`); }
    setXP(xp + userGain);
    setRivalXP(prev => { let newXP = prev + rivalGain; if (newXP >= getXPForLevel(rivalLevel)) { newXP -= getXPForLevel(rivalLevel); setRivalLevel(rivalLevel + 1); } return newXP; });
    if (first.deathMode) { const reward = rewards[Math.floor(Math.random() * rewards.length)]; alert(`Reward Unlocked: ${reward}`); }
    setPunishments(rest);
    if (rest.length === 0) setLockdown(false);
  }
  function forgivePunishment(){ setXP(Math.max(0,xp-15)); completePunishment(); }

  // === Add, Complete, Delete Tasks ===
  function addTask(){
    if(!newTask.title)return;
    const id=Date.now();
    const task={...newTask,id,done:false,created:new Date().toISOString()};
    if(newTask.type==='habit'){setHabits([...habits,task]);}
    else{setTasks([...tasks,task]);}
    setShowAddModal(false);
    setNewTask({type:'daily',title:'',start:'',end:'',days:''});
  }
  function completeTask(id){
    const completedTask=tasks.find(t=>t.id===id);
    setTasks(tasks.filter(t=>t.id!==id));
    setXP(xp+2);
    setBossCountdown(bossCountdown+1);
  }
  function completeHabit(id){
    const updated=habits.map(h=>h.id===id?{...h,done:true}:h);
    setHabits(updated);
    setXP(xp+1);
  }
  function deleteHabit(id){ setHabits(habits.filter(h=>h.id!==id)); }

  // === UI ===
  return (
    <div className={"p-4 max-w-3xl mx-auto bg-black bg-opacity-70 rounded-lg mt-6 shadow-lg "+(showLevelUp?'flash':'')}>
      <header className="text-center mb-4">
        <h1 className="text-3xl font-bold">Solo Leveling Grind</h1>
        <p className="mt-2">Level {level} ({getRank(level)})</p>
        <div className="w-full bg-gray-700 rounded h-4 mt-2 overflow-hidden">
          <div className="bg-gradient-to-r from-blue-500 to-purple-600 h-4 rounded" style={{width:`${(xp/getXPForLevel(level))*100}%`}}></div>
        </div>
        <p className="text-sm mt-1">{xp} / {getXPForLevel(level)} XP</p>
        <img src={characterImages[Math.min(level-1,characterImages.length-1)]} alt="Character" className="mx-auto w-32 mt-4"/>
        <p className="mt-2">Rival: Level {rivalLevel} ({getRank(rivalLevel)}) | XP: {rivalXP}</p>
      </header>

      {/* ✅ DAILY QUEST */}
      <div className="bg-indigo-700 p-4 rounded mb-4 text-center">
        <h2 className="text-xl font-bold">🔥 Daily Quest</h2>
        <p>{dailyQuest.text}</p>
        {dailyQuest.done?(
          <p className="text-green-400 mt-2">Completed ✅</p>
        ):(
          <button onClick={completeDailyQuest} className="bg-green-500 px-3 py-1 mt-2 rounded">Mark Done (+{dailyQuest.reward} XP)</button>
        )}
      </div>

      {/* ✅ RELAPSE BUTTON */}
      <div className="text-center mb-4">
        <button onClick={triggerRelapse} className="bg-red-600 px-4 py-2 rounded font-bold">⚠ Relapse</button>
        <p className="text-sm mt-1">Relapses so far: {relapseCount}</p>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
